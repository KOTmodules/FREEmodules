# meta developer: @kotcheat

from .. import loader, utils
import datetime
import asyncio

@loader.tds
class RussianHolidaysModule(loader.Module):
    """Модуль для определения праздников в России (by @kotcheat)"""

    strings = {
        "name": "RussianHolidays",
        "no_holiday": "Сегодня нет праздников в России.",
        "holiday": "Сегодня в России празднуется: {}",
        "next_holiday": "До ближайшего праздника осталось {} дней."
    }

    async def client_ready(self, client, db):
        self.client = client

    @loader.command()
    async def holidaycmd(self, message):
        """Узнать, какой праздник сегодня в России и сколько дней до ближайшего праздника"""
        today = datetime.date.today()
        holiday = self.get_holiday(today)
        next_holiday, days_until = self.get_next_holiday(today)

        response = []
        if holiday:
            response.append(self.strings["holiday"].format(holiday))
        else:
            response.append(self.strings["no_holiday"])

        response.append(self.strings["next_holiday"].format(days_until))

        sent_message = await utils.answer(message, "\n".join(response))

        # Удаление сообщения через 25 секунд
        await asyncio.sleep(25)
        await sent_message.delete()

    def get_holiday(self, date):
        holidays = {
            (1, 1): "Новый год",
            (1, 7): "Рождество Христово",
            (1, 13): "Старый Новый год",
            (1, 14): "Старый Новый год (православный)",
            (1, 19): "Крещение Господне",
            (1, 25): "Татьянин день",
            (2, 2): "День разгрома советскими войсками немецко-фашистских войск в Сталинградской битве",
            (2, 8): "День российской науки",
            (2, 10): "День дипломатического работника",
            (2, 14): "День всех влюбленных",
            (2, 15): "День памяти воинов-интернационалистов",
            (2, 23): "День защитника Отечества",
            (3, 1): "Всемирный день гражданской обороны",
            (3, 8): "Международный женский день",
            (3, 18): "День воссоединения Крыма с Россией",
            (3, 21): "Международный день кукольника",
            (3, 27): "День театра",
            (4, 1): "День смеха",
            (4, 2): "Международный день детской книги",
            (4, 7): "Всемирный день здоровья",
            (4, 12): "День космонавтики",
            (4, 15): "День специалиста по ядерному обеспечению",
            (4, 18): "Международный день охраны памятников и исторических мест",
            (4, 22): "День местного самоуправления",
            (4, 26): "День памяти погибших в радиационных авариях и катастрофах",
            (5, 1): "Праздник Весны и Труда",
            (5, 6): "День святого Георгия Победоносца",
            (5, 9): "День Победы",
            (5, 15): "День семьи",
            (5, 18): "Международный день музеев",
            (5, 25): "День филолога",
            (5, 27): "День библиотек",
            (5, 28): "День пограничника",
            (6, 1): "Международный день защиты детей",
            (6, 5): "День эколога",
            (6, 6): "Пушкинский день России",
            (6, 8): "День социального работника",
            (6, 12): "День России",
            (6, 14): "День работника миграционной службы",
            (6, 22): "День памяти и скорби",
            (6, 27): "День молодежи",
            (7, 7): "Иван Купала",
            (7, 8): "День семьи, любви и верности",
            (7, 28): "День крещения Руси",
            (8, 1): "День памяти русского флота",
            (8, 2): "День воздушно-десантных войск",
            (8, 6): "День железнодорожника",
            (8, 12): "День строителя",
            (8, 15): "День археолога",
            (8, 22): "День Государственного флага Российской Федерации",
            (8, 27): "День кино",
            (9, 1): "День знаний",
            (9, 3): "День солидарности в борьбе с терроризмом",
            (9, 8): "День финансиста",
            (9, 9): "День тестировщика",
            (9, 11): "День трезвости",
            (9, 13): "День программиста",
            (9, 20): "День лесного хозяйства",
            (9, 27): "Всемирный день туризма",
            (10, 1): "Международный день музыки",
            (10, 4): "День Космических войск",
            (10, 5): "День учителя",
            (10, 7): "День работника связи",
            (10, 10): "День работников сельского хозяйства и перерабатывающей промышленности",
            (10, 25): "День таможенника",
            (10, 30): "День памяти жертв политических репрессий",
            (10, 31): "Хэллоуин",
            (11, 4): "День народного единства",
            (11, 7): "День Октябрьской революции",
            (11, 10): "День милиции",
            (11, 17): "Международный день студентов",
            (11, 21): "День бухгалтера",
            (12, 3): "День юриста",
            (12, 5): "День воинской славы России",
            (12, 9): "День Героев Отечества",
            (12, 12): "День Конституции Российской Федерации",
            (12, 25): "Католическое Рождество",
            (12, 31): "Новый год"
        }

        return holidays.get((date.month, date.day))

    def get_next_holiday(self, date):
        holidays = {
            (1, 1): "Новый год",
            (1, 7): "Рождество Христово",
            (1, 13): "Старый Новый год",
            (1, 14): "Старый Новый год (православный)",
            (1, 19): "Крещение Господне",
            (1, 25): "Татьянин день",
            (2, 2): "День разгрома советскими войсками немецко-фашистских войск в Сталинградской битве",
            (2, 8): "День российской науки",
            (2, 10): "День дипломатического работника",
            (2, 14): "День всех влюбленных",
            (2, 15): "День памяти воинов-интернационалистов",
            (2, 23): "День защитника Отечества",
            (3, 1): "Всемирный день гражданской обороны",
            (3, 8): "Международный женский день",
            (3, 18): "День воссоединения Крыма с Россией",
            (3, 21): "Международный день кукольника",
            (3, 27): "День театра",
            (4, 1): "День смеха",
            (4, 2): "Международный день детской книги",
            (4, 7): "Всемирный день здоровья",
            (4, 12): "День космонавтики",
            (4, 15): "День специалиста по ядерному обеспечению",
            (4, 18): "Международный день охраны памятников и исторических мест",
            (4, 22): "День местного самоуправления",
            (4, 26): "День памяти погибших в радиационных авариях и катастрофах",
            (5, 1): "Праздник Весны и Труда",
            (5, 6): "День святого Георгия Победоносца",
            (5, 9): "День Победы",
            (5, 15): "День семьи",
            (5, 18): "Международный день музеев",
            (5, 25): "День филолога",
            (5, 27): "День библиотек",
            (5, 28): "День пограничника",
            (6, 1): "Международный день защиты детей",
            (6, 5): "День эколога",
            (6, 6): "Пушкинский день России",
            (6, 8): "День социального работника",
            (6, 12): "День России",
            (6, 14): "День работника миграционной службы",
            (6, 22): "День памяти и скорби",
            (6, 27): "День молодежи",
            (7, 7): "Иван Купала",
            (7, 8): "День семьи, любви и верности",
            (7, 28): "День крещения Руси",
            (8, 1): "День памяти русского флота",
            (8, 2): "День воздушно-десантных войск",
            (8, 6): "День железнодорожника",
            (8, 12): "День строителя",
            (8, 15): "День археолога",
            (8, 22): "День Государственного флага Российской Федерации",
            (8, 27): "День кино",
            (9, 1): "День знаний",
            (9, 3): "День солидарности в борьбе с терроризмом",
            (9, 8): "День финансиста",
            (9, 9): "День тестировщика",
            (9, 11): "День трезвости",
            (9, 13): "День программиста",
            (9, 20): "День лесного хозяйства",
            (9, 27): "Всемирный день туризма",
            (10, 1): "Международный день музыки",
            (10, 4): "День Космических войск",
            (10, 5): "День учителя",
            (10, 7): "День работника связи",
            (10, 10): "День работников сельского хозяйства и перерабатывающей промышленности",
            (10, 25): "День таможенника",
            (10, 30): "День памяти жертв политических репрессий",
            (10, 31): "Хэллоуин",
            (11, 4): "День народного единства",
            (11, 7): "День Октябрьской революции",
            (11, 10): "День милиции",
            (11, 17): "Международный день студентов",
            (11, 21): "День бухгалтера",
            (12, 3): "День юриста",
            (12, 5): "День воинской славы России",
            (12, 9): "День Героев Отечества",
            (12, 12): "День Конституции Российской Федерации",
            (12, 25): "Католическое Рождество",
            (12, 31): "Новый год"
        }

        next_holiday = None
        days_until = float('inf')

        for holiday in holidays:
            holiday_date = datetime.date(date.year, holiday[0], holiday[1])
            if holiday_date < date:
                holiday_date = datetime.date(date.year + 1, holiday[0], holiday[1])
            delta = (holiday_date - date).days
            if delta < days_until:
                days_until = delta
                next_holiday = holiday

        return next_holiday, days_until
